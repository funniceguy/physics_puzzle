(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class T{constructor(){this.screens={title:null,lobby:null,game:null,story:null,achievement:null},this.currentScreen=null,this.previousScreen=null}registerScreen(e,t){this.screens[e]=t}async showScreen(e,t={}){this.currentScreen&&this.screens[this.currentScreen]&&await this.screens[this.currentScreen].hide(),this.previousScreen=this.currentScreen,this.currentScreen=e,this.screens[e]?await this.screens[e].show(t):console.error(`Screen '${e}' not found`)}goBack(){this.previousScreen?this.showScreen(this.previousScreen):this.showScreen("lobby")}getCurrentScreen(){return this.currentScreen}isScreenActive(e){return this.currentScreen===e}}class _{constructor(){this.storageKey="lifepieces_progress",this.progress=this.load()}getDefaultProgress(){return{merges:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},levelClears:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},unlockedStories:["cherry_1"],totalScore:0,gamesPlayed:0,highestLevel:1,inventory:{remove:3,upgrade:3,vibration:3},claimedAchievements:[],completedAchievements:[],firstTimeTitleScreen:!0,firstTimeLobby:!0,firstTimeStory:!0,firstTimeAchievement:!0}}load(){try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);return t.completedAchievements||(t.completedAchievements=t.claimedAchievements?[...t.claimedAchievements]:[]),t.claimedAchievements||(t.claimedAchievements=[]),{...this.getDefaultProgress(),...t}}}catch(e){console.error("Failed to load progress:",e)}return this.getDefaultProgress()}save(){try{return localStorage.setItem(this.storageKey,JSON.stringify(this.progress)),!0}catch(e){return console.error("Failed to save progress:",e),!1}}recordMerge(e){e>=0&&e<=10&&(this.progress.merges[e]=(this.progress.merges[e]||0)+1,this.save())}recordLevelClear(e){e>=1&&e<=9&&(this.progress.levelClears[e]=(this.progress.levelClears[e]||0)+1,e>this.progress.highestLevel&&(this.progress.highestLevel=e),this.save())}completeAchievement(e){return this.progress.completedAchievements.includes(e)?!1:(this.progress.completedAchievements.push(e),this.save(),!0)}addScore(e){this.progress.totalScore+=e,this.save()}incrementGamesPlayed(){this.progress.gamesPlayed++,this.save()}unlockStory(e){return this.progress.unlockedStories.includes(e)?!1:(this.progress.unlockedStories.push(e),this.save(),!0)}isStoryUnlocked(e){return this.progress.unlockedStories.includes(e)}claimAchievement(e,t){return this.progress.claimedAchievements.includes(e)?!1:(this.progress.claimedAchievements.push(e),t&&(t.type==="item"?this.addItems(t.itemType,t.count):t.type==="story"&&this.unlockStory(t.storyId)),this.save(),!0)}isAchievementClaimed(e){return this.progress.claimedAchievements.includes(e)}updateInventory(e,t){this.progress.inventory[e]=t,this.save()}addItems(e,t){this.progress.inventory[e]=(this.progress.inventory[e]||0)+t,this.save()}getProgress(){return this.progress}getInventory(){return this.progress.inventory}markFirstTimeSeen(e){this.progress[`firstTime${e}`]!==void 0&&(this.progress[`firstTime${e}`]=!1,this.save())}reset(){this.progress=this.getDefaultProgress(),this.save()}export(){return JSON.stringify(this.progress,null,2)}import(e){try{const t=JSON.parse(e);return this.progress={...this.getDefaultProgress(),...t},this.save(),!0}catch(t){return console.error("Failed to import progress:",t),!1}}}class k{constructor(e,t){this.screenManager=e,this.progressManager=t,this.container=null}create(){const e=this.progressManager.getProgress();this.container=document.createElement("div"),this.container.id="lobby-screen",this.container.className="screen",this.container.innerHTML=`
            <div class="lobby-content">
                <div class="lobby-header">
                    <div class="lobby-logo">
                        <div class="lobby-icon">ğŸ§©</div>
                        <h1 class="lobby-title">Life Pieces</h1>
                    </div>
                    <div class="lobby-stats">
                        <div class="stat-item">
                            <span class="stat-icon">ğŸ†</span>
                            <span class="stat-value">${e.claimedAchievements.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">ğŸ“–</span>
                            <span class="stat-value">${e.unlockedStories.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">â­</span>
                            <span class="stat-value">Lv.${e.highestLevel}</span>
                        </div>
                    </div>
                </div>

                <div class="lobby-main">
                    <button class="btn-play" id="btn-start-game">
                        <span class="btn-play-icon">â–¶</span>
                        <span class="btn-play-text">ê²Œì„ ì‹œì‘</span>
                    </button>
                    <div class="lobby-info">
                        <p class="info-text">ê³¼ì¼ì„ í•©ì³ ì¸ìƒì˜ ì¡°ê°ì„ ëª¨ì•„ë³´ì„¸ìš”</p>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <button class="nav-btn" data-screen="story">
                        <span class="nav-icon">ğŸ“–</span>
                        <span class="nav-label">ìŠ¤í† ë¦¬</span>
                    </button>
                    <button class="nav-btn nav-btn-home active">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-label">í™ˆ</span>
                    </button>
                    <button class="nav-btn" data-screen="achievement">
                        <span class="nav-icon">ğŸ†</span>
                        <span class="nav-label">ì—…ì </span>
                    </button>
                </nav>
            </div>
        `,document.body.appendChild(this.container),this.setupEventListeners()}setupEventListeners(){const e=this.container.querySelector("#btn-start-game");e&&e.addEventListener("click",()=>{this.screenManager.showScreen("game")}),this.container.querySelectorAll(".nav-btn[data-screen]").forEach(i=>{i.addEventListener("click",()=>{const s=i.getAttribute("data-screen");this.screenManager.showScreen(s)})})}updateStats(){const e=this.progressManager.getProgress(),t=this.container.querySelector(".stat-item:nth-child(1) .stat-value"),i=this.container.querySelector(".stat-item:nth-child(2) .stat-value"),s=this.container.querySelector(".stat-item:nth-child(3) .stat-value");t&&(t.textContent=e.claimedAchievements.length),i&&(i.textContent=e.unlockedStories.length),s&&(s.textContent=`Lv.${e.highestLevel}`)}async show(){this.container||this.create(),this.updateStats(),this.container.classList.add("active"),this.container.querySelectorAll(".nav-btn").forEach(i=>i.classList.remove("active"));const t=this.container.querySelector(".nav-btn-home");t&&t.classList.add("active")}async hide(){this.container&&this.container.classList.remove("active")}}const E=[{id:"cherry",name:"Cherry",emoji:"ğŸ’",title:"ì‹œì‘ì˜ ìˆœê°„",unlockCondition:{type:"default",value:!0},stories:[{id:"cherry_1",title:"ì²« ê±¸ìŒ",content:"ëª¨ë“  ìœ„ëŒ€í•œ ì—¬ì •ì€ ì‘ì€ í•œ ê±¸ìŒì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤. ì²´ë¦¬ì²˜ëŸ¼ ì‘ê³  ì†Œì¤‘í•œ ì‹œì‘ì´ ìˆì—ˆê¸°ì— ì§€ê¸ˆì˜ ë‹¹ì‹ ì´ ìˆìŠµë‹ˆë‹¤. ë‘ë ¤ì›Œí•˜ì§€ ë§ˆì„¸ìš”. ì‹œì‘ì´ ì‘ë‹¤ê³  í•´ì„œ ê²°ê³¼ë„ ì‘ì€ ê²ƒì€ ì•„ë‹ˆë‹ˆê¹Œìš”. ì˜¤ëŠ˜ì˜ ì‘ì€ ìš©ê¸°ê°€ ë‚´ì¼ì˜ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.",unlocked:!0},{id:"cherry_2",title:"ìˆœìˆ˜í•œ ì—´ì •",content:"ì²˜ìŒ ë¬´ì–¸ê°€ë¥¼ ì‹œì‘í•  ë•Œì˜ ê·¸ ì„¤ë ˜ì„ ê¸°ì–µí•˜ì‹œë‚˜ìš”? ì²´ë¦¬ì˜ ë¶‰ì€ ë¹›ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê³  ëœ¨ê±°ì› ë˜ ê·¸ ë§ˆìŒ. ë•Œë¡œëŠ” ê²½í—˜ì´ ìš°ë¦¬ë¥¼ í˜„ëª…í•˜ê²Œ ë§Œë“¤ì§€ë§Œ, ì´ˆì‹¬ì˜ ì—´ì •ë§Œí¼ ê°•ë ¥í•œ ê²ƒì€ ì—†ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ë„ ì²˜ìŒì²˜ëŸ¼ ë„ì „í•˜ì„¸ìš”.",unlocked:!1},{id:"cherry_3",title:"ì‘ì§€ë§Œ ì™„ë²½í•œ",content:"ì²´ë¦¬ëŠ” ì‘ì§€ë§Œ ì™„ë²½í•©ë‹ˆë‹¤. í¬ê¸°ê°€ ê°€ì¹˜ë¥¼ ê²°ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì‘ì€ ë…¸ë ¥, ì‘ì€ ì¹œì ˆ, ì‘ì€ ì„±ì·¨ë“¤ì´ ëª¨ì—¬ ì•„ë¦„ë‹¤ìš´ ì¸ìƒì„ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ ë‹¹ì‹ ì´ í•œ ì‘ì€ ì¼ë“¤ì„ ìë‘ìŠ¤ëŸ¬ì›Œí•˜ì„¸ìš”.",unlocked:!1}]},{id:"berry",name:"Berry",emoji:"ğŸ“",title:"ì—´ì •ì˜ ë¶ˆê½ƒ",unlockCondition:{type:"merge",fruit:0,count:5},stories:[{id:"berry_1",title:"ë„ì „ì˜ ì‹œì‘",content:"ë”¸ê¸°ëŠ” ë•…ì—ì„œ ìë¼ì§€ë§Œ í•˜ëŠ˜ì„ í–¥í•´ ë¶‰ê²Œ ìµì–´ê°‘ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë„ì „ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ ë•…ì— ë°œì„ ë”›ê³  ìˆì§€ë§Œ, ë‹¹ì‹ ì˜ ì—´ì •ì€ í•˜ëŠ˜ì„ í–¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”. ê°€ì¥ ë‹¬ì½¤í•œ ì—´ë§¤ëŠ” ê°€ì¥ ë§ì€ í–‡ì‚´ì„ ë°›ì€ ê²ƒì´ë‹ˆê¹Œìš”.",unlocked:!1},{id:"berry_2",title:"ìƒì²˜ë„ ì„±ì¥",content:"ë”¸ê¸°ì˜ ì”¨ì•—ì€ ê²‰ì— ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ê²ƒì´ ë“œëŸ¬ë‚˜ ìˆì£ . ë•Œë¡œëŠ” ìš°ë¦¬ì˜ ì•½ì ê³¼ ìƒì²˜ë„ ê·¸ë ‡ê²Œ ë“œëŸ¬ë‚˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê·¸ê²ƒì´ ë”¸ê¸°ë¥¼ ëœ ì•„ë¦„ë‹µê²Œ ë§Œë“¤ì§€ ì•Šë“¯ì´, ë‹¹ì‹ ì˜ ìƒì²˜ë„ ë‹¹ì‹ ì„ ëœ ê°€ì¹˜ìˆê²Œ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜¤íˆë ¤ ê·¸ê²ƒì´ ë‹¹ì‹ ì„ íŠ¹ë³„í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.",unlocked:!1},{id:"berry_3",title:"ë‹¬ì½¤í•œ ë³´ìƒ",content:"ì—´ì •ì„ ë‹¤í•´ ë…¸ë ¥í•œ ëì— ì˜¤ëŠ” ì„±ì·¨ëŠ” ë”¸ê¸°ì²˜ëŸ¼ ë‹¬ì½¤í•©ë‹ˆë‹¤. ê·¸ ê³¼ì •ì´ í˜ë“¤ì—ˆì„ìˆ˜ë¡ ê²°ê³¼ëŠ” ë” ë‹¬ì½¤í•˜ì£ . ì§€ê¸ˆ í˜ë“¤ë‹¤ë©´, ê·¸ê²ƒì€ ê³§ ë‹¤ê°€ì˜¬ ë‹¬ì½¤í•œ ìˆœê°„ì„ ìœ„í•œ ì¤€ë¹„ì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„¸ìš”.",unlocked:!1}]},{id:"grape",name:"Grape",emoji:"ğŸ‡",title:"ì¸ë‚´ì˜ ì—´ë§¤",unlockCondition:{type:"merge",fruit:1,count:10},stories:[{id:"grape_1",title:"í•¨ê»˜ì˜ í˜",content:"í¬ë„ëŠ” í˜¼ì ìë¼ì§€ ì•ŠìŠµë‹ˆë‹¤. ì†¡ì´ë¥¼ ì´ë£¨ì–´ í•¨ê»˜ ìµì–´ê°‘ë‹ˆë‹¤. ìš°ë¦¬ì˜ ì¸ìƒë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. í˜¼ìì„œëŠ” í•  ìˆ˜ ì—†ëŠ” ì¼ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ì£¼ë³€ì˜ ì†Œì¤‘í•œ ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ì„±ì¥í•˜ì„¸ìš”. í•¨ê»˜ë¼ë©´ ë” í’ì„±í•œ ì—´ë§¤ë¥¼ ë§ºì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",unlocked:!1},{id:"grape_2",title:"ì‹œê°„ì˜ ì„ ë¬¼",content:"ì¢‹ì€ ì™€ì¸ì€ ì˜¤ë˜ ìˆ™ì„±ëœ í¬ë„ë¡œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. ì„œë‘ë¥´ì§€ ë§ˆì„¸ìš”. ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ê¸°ë‹¤ë¦¬ì„¸ìš”. ì‹œê°„ì€ ëª¨ë“  ê²ƒì„ ë” ê¹Šê³  í’ë¶€í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë…¸ë ¥ë„ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë” í° ê°€ì¹˜ë¥¼ ë°œíœ˜í•  ê²ƒì…ë‹ˆë‹¤.",unlocked:!1},{id:"grape_3",title:"ì‘ì€ ê²ƒë“¤ì˜ ì¡°í™”",content:"í¬ë„ì†¡ì´ëŠ” ìˆ˜ë§ì€ ì‘ì€ ì•Œê°±ì´ë“¤ì´ ëª¨ì—¬ ì•„ë¦„ë‹¤ì›€ì„ ë§Œë“­ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¸ìƒë„ ìˆ˜ë§ì€ ì‘ì€ ìˆœê°„ë“¤ì´ ëª¨ì—¬ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. í•˜ë‚˜í•˜ë‚˜ì˜ ìˆœê°„ì„ ì†Œì¤‘íˆ ì—¬ê¸°ì„¸ìš”. ê·¸ ëª¨ë“  ìˆœê°„ì´ ëª¨ì—¬ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ê°€ ë©ë‹ˆë‹¤.",unlocked:!1}]},{id:"tangy",name:"Tangy",emoji:"ğŸŠ",title:"ë”°ëœ»í•œ ë§ˆìŒ",unlockCondition:{type:"merge",fruit:2,count:15},stories:[{id:"tangy_1",title:"ë‚˜ëˆ”ì˜ ê¸°ì¨",content:"ê·¤ì€ ì‰½ê²Œ ë‚˜ëˆŒ ìˆ˜ ìˆë„ë¡ ì¡°ê°ì¡°ê° ë‚˜ë‰˜ì–´ ìˆìŠµë‹ˆë‹¤. ì§„ì •í•œ í–‰ë³µì€ ë‚˜ëˆ”ì—ì„œ ì˜µë‹ˆë‹¤. ë‹¹ì‹ ì´ ê°€ì§„ ê²ƒì„ ë‚˜ëˆ„ì„¸ìš”. ì§€ì‹ì´ë“ , ì‹œê°„ì´ë“ , ë¯¸ì†Œë“ . ë‚˜ëˆŒìˆ˜ë¡ ë” í’ìš”ë¡œì›Œì§€ëŠ” ê²ƒì´ ì¸ìƒì…ë‹ˆë‹¤.",unlocked:!1},{id:"tangy_2",title:"ë”°ëœ»í•¨ì˜ ì „íŒŒ",content:"ê·¤ì˜ ì£¼í™©ë¹›ì€ ë”°ëœ»í•¨ì„ ìƒì§•í•©ë‹ˆë‹¤. ì¶”ìš´ ê²¨ìš¸ë‚  ê·¤ í•œ ì¡°ê°ì´ ì£¼ëŠ” ìœ„ë¡œì²˜ëŸ¼, ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ë§ í•œë§ˆë””ê°€ ëˆ„êµ°ê°€ì—ê²ŒëŠ” í° ìœ„ë¡œê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ëˆ„êµ°ê°€ì—ê²Œ ë”°ëœ»í•¨ì„ ì „í•˜ì„¸ìš”.",unlocked:!1},{id:"tangy_3",title:"ê´€ê³„ì˜ ì†Œì¤‘í•¨",content:"ê·¤ì€ í•¨ê»˜ ë‚˜ëˆ  ë¨¹ì„ ë•Œ ê°€ì¥ ë§›ìˆìŠµë‹ˆë‹¤. ì¸ìƒì˜ ê¸°ì¨ë„ í•¨ê»˜ ë‚˜ëˆŒ ë•Œ ë°°ê°€ ë©ë‹ˆë‹¤. ì†Œì¤‘í•œ ì‚¬ëŒë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì‹œê°„ì„ ë§Œë“œì„¸ìš”. ê·¸ ìˆœê°„ë“¤ì´ ë‹¹ì‹ ì˜ ê°€ì¥ ì†Œì¤‘í•œ ì¶”ì–µì´ ë  ê²ƒì…ë‹ˆë‹¤.",unlocked:!1}]},{id:"lemon",name:"Lemon",emoji:"ğŸ‹",title:"ì—­ê²½ì˜ ê·¹ë³µ",unlockCondition:{type:"level",level:2,count:1},stories:[{id:"lemon_1",title:"ì“´ë§›ë„ ì•½ì´ ëœë‹¤",content:"ë ˆëª¬ì€ ì‹œì§€ë§Œ ê±´ê°•ì— ì¢‹ìŠµë‹ˆë‹¤. ì¸ìƒì˜ ì“´ ê²½í—˜ë“¤ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ í˜ë“¤ê³  ê³ í†µìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆì§€ë§Œ, ê·¸ ê²½í—˜ì´ ë‹¹ì‹ ì„ ë” ê°•í•˜ê³  ì§€í˜œë¡­ê²Œ ë§Œë“¤ ê²ƒì…ë‹ˆë‹¤. ë ˆëª¬ì—ì´ë“œì²˜ëŸ¼, ì“´ ê²½í—˜ì„ ë‹¬ì½¤í•œ êµí›ˆìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.",unlocked:!1},{id:"lemon_2",title:"ì—­ê²½ ì†ì˜ ë¹›",content:"ë ˆëª¬ì˜ ë…¸ë€ìƒ‰ì€ ì–´ë‘  ì†ì—ì„œë„ ë¹›ë‚©ë‹ˆë‹¤. ê°€ì¥ ì–´ë‘ìš´ ìˆœê°„ì—ë„ í¬ë§ì˜ ë¹›ì€ ìˆìŠµë‹ˆë‹¤. í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”. ë‹¹ì‹  ì•ˆì—ëŠ” ì–´ë–¤ ì–´ë‘ ë„ ë°í ìˆ˜ ìˆëŠ” ë¹›ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ ë¹›ì„ ë¯¿ìœ¼ì„¸ìš”.",unlocked:!1},{id:"lemon_3",title:"ë³€í™”ì˜ ì´‰ë§¤",content:"ë ˆëª¬ì€ ë‹¤ë¥¸ ì¬ë£Œì˜ ë§›ì„ ëŒì–´ì˜¬ë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì–´ë ¤ì›€ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ê·¸ê²ƒì´ ë‹¹ì‹ ì„ ë” ë‚˜ì€ ì‚¬ëŒìœ¼ë¡œ ë³€í™”ì‹œí‚¬ ì´‰ë§¤ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—­ê²½ì„ ì„±ì¥ì˜ ê¸°íšŒë¡œ ë§Œë“œì„¸ìš”.",unlocked:!1}]},{id:"melon",name:"Melon",emoji:"ğŸˆ",title:"ì„±ìˆ™ì˜ ì§€í˜œ",unlockCondition:{type:"merge",fruit:4,count:20},stories:[{id:"melon_1",title:"ê²‰ê³¼ ì†",content:"ë©œë¡ ì€ ê²‰ì€ ê±°ì¹ ì§€ë§Œ ì†ì€ ë‹¬ì½¤í•©ë‹ˆë‹¤. ì‚¬ëŒë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ê²‰ëª¨ìŠµë§Œìœ¼ë¡œ íŒë‹¨í•˜ì§€ ë§ˆì„¸ìš”. ì§„ì •í•œ ê°€ì¹˜ëŠ” ë‚´ë©´ì— ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹  ìì‹ ë„, ë‹¤ë¥¸ ì‚¬ëŒë„ ë‚´ë©´ì˜ ì•„ë¦„ë‹¤ì›€ì„ ë°œê²¬í•˜ì„¸ìš”.",unlocked:!1},{id:"melon_2",title:"ì™„ìˆ™ì˜ ë•Œ",content:"ë©œë¡ ì€ ì™„ë²½í•˜ê²Œ ìµì—ˆì„ ë•Œ ê°€ì¥ ë§›ìˆìŠµë‹ˆë‹¤. ì„œë‘ë¥´ì§€ ë§ˆì„¸ìš”. ëª¨ë“  ê²ƒì—ëŠ” ë•Œê°€ ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë•Œê°€ ì˜¬ ë•Œê¹Œì§€ ê¾¸ì¤€íˆ ì„±ì¥í•˜ì„¸ìš”. ì™„ë²½í•œ íƒ€ì´ë°ì€ ë°˜ë“œì‹œ ì˜µë‹ˆë‹¤.",unlocked:!1},{id:"melon_3",title:"í’ìš”ë¡œìš´ ë§ˆìŒ",content:"ë©œë¡ ì€ í¬ê³  í’ì„±í•©ë‹ˆë‹¤. ì„±ìˆ™í•œ ë§ˆìŒì€ í’ìš”ë¡­ìŠµë‹ˆë‹¤. ê²½í—˜ì´ ìŒ“ì´ê³  ì§€í˜œê°€ ê¹Šì–´ì§ˆìˆ˜ë¡, ë‹¹ì‹ ì˜ ë§ˆìŒë„ ë” ë„“ê³  í’ìš”ë¡œì›Œì§‘ë‹ˆë‹¤. ê·¸ í’ìš”ë¡œì›€ì„ ì„¸ìƒê³¼ ë‚˜ëˆ„ì„¸ìš”.",unlocked:!1}]},{id:"pine",name:"Pine",emoji:"ğŸ",title:"ë…íŠ¹í•¨ì˜ ê°€ì¹˜",unlockCondition:{type:"merge",fruit:5,count:25},stories:[{id:"pine_1",title:"ë‚˜ë§Œì˜ ê¸¸",content:"íŒŒì¸ì• í”Œì€ ë…íŠ¹í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ê³¼ì¼ê³¼ ì „í˜€ ë‹¤ë¥¸ ëª¨ìŠµì´ì£ . ë‹¹ì‹ ë„ ë…íŠ¹í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒê³¼ ë¹„êµí•˜ì§€ ë§ˆì„¸ìš”. ë‹¹ì‹ ë§Œì˜ ê¸¸ì„ ê°€ì„¸ìš”. ê·¸ ê¸¸ì´ ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ê¸¸ì…ë‹ˆë‹¤.",unlocked:!1},{id:"pine_2",title:"ê²‰ì˜ ê°€ì‹œ, ì†ì˜ ë‹¬ì½¤í•¨",content:"íŒŒì¸ì• í”Œì€ ê²‰ì´ ê¹Œì¹ í•˜ì§€ë§Œ ì†ì€ ë‹¬ì½¤í•©ë‹ˆë‹¤. ë•Œë¡œëŠ” ìì‹ ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ê°•í•´ ë³´ì—¬ì•¼ í•  ë•Œê°€ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹ ì˜ ì§„ì§œ ëª¨ìŠµ, ë”°ëœ»í•˜ê³  ë‹¬ì½¤í•œ ë‚´ë©´ì„ ìŠì§€ ë§ˆì„¸ìš”. ê·¸ê²ƒì´ ì§„ì§œ ë‹¹ì‹ ì…ë‹ˆë‹¤.",unlocked:!1},{id:"pine_3",title:"ì™•ê´€ì„ ì“´ ê³¼ì¼",content:"íŒŒì¸ì• í”Œì€ ì™•ê´€ì„ ì“°ê³  ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ë„ ë‹¹ì‹  ì¸ìƒì˜ ì™•ì…ë‹ˆë‹¤. ìì‹ ê°ì„ ê°€ì§€ì„¸ìš”. ë‹¹ì‹ ì€ íŠ¹ë³„í•˜ê³  ê°€ì¹˜ìˆëŠ” ì¡´ì¬ì…ë‹ˆë‹¤. ë‹¹ë‹¹í•˜ê²Œ ë‹¹ì‹ ì˜ ì™•ê´€ì„ ì“°ì„¸ìš”.",unlocked:!1}]},{id:"peach",name:"Peach",emoji:"ğŸ‘",title:"ë¶€ë“œëŸ¬ì›€ì˜ í˜",unlockCondition:{type:"level",level:3,count:1},stories:[{id:"peach_1",title:"ë¶€ë“œëŸ¬ìš´ ê°•í•¨",content:"ë³µìˆ­ì•„ëŠ” ë¶€ë“œëŸ½ì§€ë§Œ ê°•í•©ë‹ˆë‹¤. ë¶€ë“œëŸ¬ì›€ì€ ì•½í•¨ì´ ì•„ë‹™ë‹ˆë‹¤. ì˜¤íˆë ¤ ì§„ì •í•œ ê°•í•¨ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë¶€ë“œëŸ½ê²Œ ëŒ€í•˜ì„¸ìš”. ê·¸ê²ƒì´ ë‹¹ì‹ ì˜ ì§„ì§œ í˜ì…ë‹ˆë‹¤.",unlocked:!1},{id:"peach_2",title:"ë°°ë ¤ì˜ í–¥ê¸°",content:"ë³µìˆ­ì•„ëŠ” ë‹¬ì½¤í•œ í–¥ê¸°ë¥¼ í¼ëœ¨ë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë°°ë ¤ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤. ì‘ì€ ë°°ë ¤ê°€ í° ê°ë™ì„ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ ëˆ„êµ°ê°€ë¥¼ ë°°ë ¤í•˜ì„¸ìš”. ê·¸ í–¥ê¸°ê°€ ì„¸ìƒì„ ì•„ë¦„ë‹µê²Œ ë§Œë“­ë‹ˆë‹¤.",unlocked:!1},{id:"peach_3",title:"ì„¬ì„¸í•œ ì•„ë¦„ë‹¤ì›€",content:"ë³µìˆ­ì•„ì˜ ì•„ë¦„ë‹¤ì›€ì€ ì„¬ì„¸í•¨ì— ìˆìŠµë‹ˆë‹¤. ì¸ìƒì˜ ì•„ë¦„ë‹¤ì›€ë„ ì„¬ì„¸í•œ ìˆœê°„ë“¤ì— ìˆìŠµë‹ˆë‹¤. ì‘ì€ ê²ƒë“¤ì— ê°ì‚¬í•˜ì„¸ìš”. ì•„ì¹¨ í–‡ì‚´, ë”°ëœ»í•œ ì°¨, ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒì˜ ë¯¸ì†Œ. ê·¸ ëª¨ë“  ê²ƒì´ ë‹¹ì‹ ì˜ ì¸ìƒì„ ì•„ë¦„ë‹µê²Œ ë§Œë“­ë‹ˆë‹¤.",unlocked:!1}]},{id:"green",name:"Green",emoji:"ğŸ",title:"ê· í˜•ì˜ ì§€í˜œ",unlockCondition:{type:"merge",fruit:7,count:30},stories:[{id:"green_1",title:"ê±´ê°•í•œ ì‚¶",content:"ì²­ì‚¬ê³¼ëŠ” ê±´ê°•ì„ ìƒì§•í•©ë‹ˆë‹¤. ëª¸ê³¼ ë§ˆìŒì˜ ê±´ê°•ì„ ëŒë³´ì„¸ìš”. ë°”ìœ ì¼ìƒ ì†ì—ì„œë„ ìì‹ ì„ ëŒë³´ëŠ” ì‹œê°„ì„ ê°€ì§€ì„¸ìš”. ê±´ê°•í•œ ë‹¹ì‹ ì´ ìˆì–´ì•¼ ë‹¤ë¥¸ ëª¨ë“  ê²ƒë„ ì˜ë¯¸ê°€ ìˆìŠµë‹ˆë‹¤.",unlocked:!1},{id:"green_2",title:"ì‹ ì„ í•œ ì‹œì‘",content:"ì²­ì‚¬ê³¼ì˜ ìƒí¼í•¨ì€ ìƒˆë¡œìš´ ì‹œì‘ì„ ë– ì˜¬ë¦¬ê²Œ í•©ë‹ˆë‹¤. ë§¤ì¼ì´ ìƒˆë¡œìš´ ì‹œì‘ì…ë‹ˆë‹¤. ì–´ì œì˜ ì‹¤ìˆ˜ì— ì–½ë§¤ì´ì§€ ë§ˆì„¸ìš”. ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ ê¸°íšŒì…ë‹ˆë‹¤. ì‹ ì„ í•œ ë§ˆìŒìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.",unlocked:!1},{id:"green_3",title:"ê· í˜• ì¡íŒ ì¸ìƒ",content:"ì²­ì‚¬ê³¼ëŠ” ë‹¬ì½¤í•¨ê³¼ ì‹ ë§›ì˜ ê· í˜•ì´ ì™„ë²½í•©ë‹ˆë‹¤. ì¸ìƒë„ ê· í˜•ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì¼ê³¼ íœ´ì‹, ë…¸ë ¥ê³¼ ì—¬ìœ , ì£¼ëŠ” ê²ƒê³¼ ë°›ëŠ” ê²ƒ. ê· í˜•ì„ ì°¾ìœ¼ì„¸ìš”. ê·¸ê²ƒì´ í–‰ë³µì˜ ë¹„ê²°ì…ë‹ˆë‹¤.",unlocked:!1}]},{id:"apple",name:"Apple",emoji:"ğŸ",title:"ì„±ì·¨ì˜ ê¸°ì¨",unlockCondition:{type:"level",level:5,count:1},stories:[{id:"apple_1",title:"ì™„ì„±ì˜ ìˆœê°„",content:"ë¹¨ê°„ ì‚¬ê³¼ëŠ” ì™„ë²½í•˜ê²Œ ìµì€ ì—´ë§¤ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë…¸ë ¥ë„ ê²°ì‹¤ì„ ë§ºì„ ê²ƒì…ë‹ˆë‹¤. í¬ê¸°í•˜ì§€ ì•Šê³  ì—¬ê¸°ê¹Œì§€ ì˜¨ ë‹¹ì‹ ì„ ìë‘ìŠ¤ëŸ¬ì›Œí•˜ì„¸ìš”. ì™„ì„±ì˜ ìˆœê°„ì€ ê°€ê¹Œì´ ìˆìŠµë‹ˆë‹¤.",unlocked:!1},{id:"apple_2",title:"ì§€í˜œì˜ ì—´ë§¤",content:"ì‚¬ê³¼ëŠ” ì§€í˜œë¥¼ ìƒì§•í•©ë‹ˆë‹¤. ë‹¹ì‹ ì´ ê²ªì€ ëª¨ë“  ê²½í—˜ì´ ì§€í˜œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ ì§€í˜œë¥¼ ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ë‚˜ëˆ„ì„¸ìš”. ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ê°€ ëˆ„êµ°ê°€ì—ê²Œ í° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",unlocked:!1},{id:"apple_3",title:"ìƒˆë¡œìš´ ì”¨ì•—",content:"ì‚¬ê³¼ ì•ˆì—ëŠ” ìƒˆë¡œìš´ ì”¨ì•—ì´ ìˆìŠµë‹ˆë‹¤. í•˜ë‚˜ì˜ ì„±ì·¨ëŠ” ë˜ ë‹¤ë¥¸ ì‹œì‘ì…ë‹ˆë‹¤. ë©ˆì¶”ì§€ ë§ˆì„¸ìš”. ë‹¹ì‹ ì˜ ì—¬ì •ì€ ê³„ì†ë©ë‹ˆë‹¤. ë” í° ê¿ˆì„ ê¾¸ì„¸ìš”.",unlocked:!1}]},{id:"watermelon",name:"Watermelon",emoji:"ğŸ‰",title:"í’ìš”ì™€ ë‚˜ëˆ”",unlockCondition:{type:"merge",fruit:9,count:50},stories:[{id:"watermelon_1",title:"í’ìš”ë¡œìš´ ì‚¶",content:"ìˆ˜ë°•ì€ í¬ê³  í’ì„±í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¸ìƒë„ í’ìš”ë¡œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬¼ì§ˆì  í’ìš”ë¿ë§Œ ì•„ë‹ˆë¼ ì‚¬ë‘, ìš°ì •, ê²½í—˜ì˜ í’ìš”. ê°ì‚¬í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ì‚´ì•„ê°€ì„¸ìš”. ê°ì‚¬ëŠ” ë” ë§ì€ í’ìš”ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.",unlocked:!1},{id:"watermelon_2",title:"í•¨ê»˜ ë‚˜ëˆ„ëŠ” ê¸°ì¨",content:"ìˆ˜ë°•ì€ í˜¼ì ë¨¹ê¸°ì—” ë„ˆë¬´ í½ë‹ˆë‹¤. í•¨ê»˜ ë‚˜ëˆ  ë¨¹ì„ ë•Œ ê°€ì¥ ë§›ìˆì£ . ë‹¹ì‹ ì´ ì´ë£¬ ì„±ì·¨ë¥¼ ì£¼ë³€ ì‚¬ëŒë“¤ê³¼ ë‚˜ëˆ„ì„¸ìš”. í•¨ê»˜ ê¸°ë»í•  ë•Œ ê·¸ ê¸°ì¨ì€ ë°°ê°€ ë©ë‹ˆë‹¤.",unlocked:!1},{id:"watermelon_3",title:"ì—¬ë¦„ì˜ ì„ ë¬¼",content:"ìˆ˜ë°•ì€ ë”ìš´ ì—¬ë¦„ë‚  ìµœê³ ì˜ ì„ ë¬¼ì…ë‹ˆë‹¤. ë‹¹ì‹ ë„ ëˆ„êµ°ê°€ì—ê²Œ ì„ ë¬¼ ê°™ì€ ì¡´ì¬ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¡´ì¬ ìì²´ê°€ ëˆ„êµ°ê°€ì—ê²ŒëŠ” í° ìœ„ë¡œì´ê³  ê¸°ì¨ì…ë‹ˆë‹¤. ê·¸ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”.",unlocked:!1}]}];function A(c){return E.filter(e=>{if(e.unlockCondition.type==="default")return!0;if(e.unlockCondition.type==="merge"){const t=e.unlockCondition.fruit,i=e.unlockCondition.count;return(c.merges[t]||0)>=i}if(e.unlockCondition.type==="level"){const t=e.unlockCondition.level,i=e.unlockCondition.count;return(c.levelClears[t]||0)>=i}return!1})}class B{constructor(e,t){this.screenManager=e,this.progressManager=t,this.container=null,this.currentCharacter=null,this.currentStory=null}create(){this.container=document.createElement("div"),this.container.id="story-screen",this.container.className="screen",this.container.innerHTML=`
            <div class="story-content">
                <div class="story-header">
                    <button class="btn-back" id="story-back">
                        <span>â†</span>
                    </button>
                    <h2 class="story-title">ì¸ìƒì˜ ì¡°ê°ë“¤</h2>
                    <div class="header-spacer"></div>
                </div>

                <div class="character-select" id="character-select">
                    <!-- Characters will be populated here -->
                </div>

                <div class="story-viewer hidden" id="story-viewer">
                    <div class="story-viewer-header">
                        <button class="btn-back-to-chars" id="back-to-chars">
                            <span>â†</span>
                        </button>
                        <h3 class="character-name" id="character-name"></h3>
                    </div>
                    <div class="story-list" id="story-list">
                        <!-- Stories will be populated here -->
                    </div>
                </div>

                <div class="story-reader hidden" id="story-reader">
                    <div class="story-reader-header">
                        <button class="btn-close-reader" id="close-reader">
                            <span>Ã—</span>
                        </button>
                    </div>
                    <div class="story-reader-content">
                        <div class="story-character-icon" id="reader-icon"></div>
                        <h3 class="story-reader-title" id="reader-title"></h3>
                        <p class="story-reader-text" id="reader-text"></p>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <button class="nav-btn active" data-screen="story">
                        <span class="nav-icon">ğŸ“–</span>
                        <span class="nav-label">ìŠ¤í† ë¦¬</span>
                    </button>
                    <button class="nav-btn" data-screen="lobby">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-label">í™ˆ</span>
                    </button>
                    <button class="nav-btn" data-screen="achievement">
                        <span class="nav-icon">ğŸ†</span>
                        <span class="nav-label">ì—…ì </span>
                    </button>
                </nav>
            </div>
        `,document.body.appendChild(this.container),this.setupEventListeners()}setupEventListeners(){const e=this.container.querySelector("#story-back");e&&e.addEventListener("click",()=>{this.screenManager.showScreen("lobby")});const t=this.container.querySelector("#back-to-chars");t&&t.addEventListener("click",()=>{this.showCharacterSelect()});const i=this.container.querySelector("#close-reader");i&&i.addEventListener("click",()=>{this.closeStoryReader()}),this.container.querySelectorAll(".nav-btn[data-screen]").forEach(n=>{n.addEventListener("click",()=>{const r=n.getAttribute("data-screen");this.screenManager.showScreen(r)})})}populateCharacters(){const e=this.progressManager.getProgress(),t=A(e),i=this.container.querySelector("#character-select");i&&(i.innerHTML="",E.forEach(s=>{const n=t.some(l=>l.id===s.id),r=document.createElement("div");r.className=`character-card ${n?"":"locked"}`,r.innerHTML=`
                <div class="char-icon">${n?s.emoji:"ğŸ”’"}</div>
                <div class="char-info">
                    <div class="char-name">${n?s.name:"???"}</div>
                    <div class="char-title">${n?s.title:"ì ê¹€"}</div>
                </div>
            `,n&&r.addEventListener("click",()=>{this.showCharacterStories(s)}),i.appendChild(r)}))}showCharacterStories(e){this.currentCharacter=e;const t=this.container.querySelector("#character-select"),i=this.container.querySelector("#story-viewer"),s=this.container.querySelector("#character-name"),n=this.container.querySelector("#story-list");!i||!n||(t.classList.add("hidden"),i.classList.remove("hidden"),s.textContent=`${e.emoji} ${e.name}`,n.innerHTML="",e.stories.forEach(r=>{const l=this.progressManager.isStoryUnlocked(r.id),a=document.createElement("div");a.className=`story-card ${l?"":"locked"}`,a.innerHTML=`
                <div class="story-card-icon">${l?"ğŸ“„":"ğŸ”’"}</div>
                <div class="story-card-info">
                    <div class="story-card-title">${l?r.title:"???"}</div>
                    <div class="story-card-preview">${l?r.content.substring(0,30)+"...":"ì ê¸´ ìŠ¤í† ë¦¬"}</div>
                </div>
            `,l&&a.addEventListener("click",()=>{this.openStoryReader(r)}),n.appendChild(a)}))}showCharacterSelect(){const e=this.container.querySelector("#character-select"),t=this.container.querySelector("#story-viewer");e&&t&&(e.classList.remove("hidden"),t.classList.add("hidden")),this.currentCharacter=null}openStoryReader(e){this.currentStory=e;const t=this.container.querySelector("#story-reader"),i=this.container.querySelector("#reader-icon"),s=this.container.querySelector("#reader-title"),n=this.container.querySelector("#reader-text");t&&(i.textContent=this.currentCharacter.emoji,s.textContent=e.title,n.textContent=e.content,t.classList.remove("hidden"))}closeStoryReader(){const e=this.container.querySelector("#story-reader");e&&e.classList.add("hidden"),this.currentStory=null}async show(){this.container||this.create(),this.populateCharacters(),this.showCharacterSelect(),this.container.classList.add("active"),this.container.querySelectorAll(".nav-btn").forEach(i=>i.classList.remove("active"));const t=this.container.querySelector('.nav-btn[data-screen="story"]');t&&t.classList.add("active")}async hide(){this.container&&(this.container.classList.remove("active"),this.closeStoryReader(),this.showCharacterSelect())}}const I=[{id:"merge_cherry_5",name:"ì²« ë§Œë‚¨",description:"ì²´ë¦¬ë¥¼ 5ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ’",requirement:{type:"merge",fruit:0,count:5},reward:{type:"story",characterId:"berry",storyId:"berry_1"},completed:!1},{id:"merge_cherry_20",name:"ì²´ë¦¬ ë§ˆìŠ¤í„°",description:"ì²´ë¦¬ë¥¼ 20ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ’",requirement:{type:"merge",fruit:0,count:20},reward:{type:"item",itemType:"remove",count:1},completed:!1},{id:"merge_berry_10",name:"ì—´ì •ì˜ ì‹œì‘",description:"ë”¸ê¸°ë¥¼ 10ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ“",requirement:{type:"merge",fruit:1,count:10},reward:{type:"story",characterId:"grape",storyId:"grape_1"},completed:!1},{id:"merge_berry_30",name:"ë”¸ê¸° ë§ˆìŠ¤í„°",description:"ë”¸ê¸°ë¥¼ 30ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ“",requirement:{type:"merge",fruit:1,count:30},reward:{type:"item",itemType:"upgrade",count:1},completed:!1},{id:"merge_grape_15",name:"ì¸ë‚´ì˜ ì—´ë§¤",description:"í¬ë„ë¥¼ 15ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‡",requirement:{type:"merge",fruit:2,count:15},reward:{type:"story",characterId:"tangy",storyId:"tangy_1"},completed:!1},{id:"merge_grape_40",name:"í¬ë„ ë§ˆìŠ¤í„°",description:"í¬ë„ë¥¼ 40ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‡",requirement:{type:"merge",fruit:2,count:40},reward:{type:"item",itemType:"vibration",count:1},completed:!1},{id:"merge_tangy_20",name:"ë”°ëœ»í•œ ë§ˆìŒ",description:"ê·¤ì„ 20ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸŠ",requirement:{type:"merge",fruit:3,count:20},reward:{type:"story",characterId:"lemon",storyId:"lemon_2"},completed:!1},{id:"merge_lemon_25",name:"ì—­ê²½ì˜ ê·¹ë³µ",description:"ë ˆëª¬ì„ 25ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‹",requirement:{type:"merge",fruit:4,count:25},reward:{type:"story",characterId:"melon",storyId:"melon_1"},completed:!1},{id:"merge_melon_30",name:"ì„±ìˆ™ì˜ ì§€í˜œ",description:"ë©œë¡ ì„ 30ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸˆ",requirement:{type:"merge",fruit:5,count:30},reward:{type:"item",itemType:"remove",count:2},completed:!1},{id:"merge_pine_35",name:"ë…íŠ¹í•œ ì¡´ì¬",description:"íŒŒì¸ì• í”Œì„ 35ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ",requirement:{type:"merge",fruit:6,count:35},reward:{type:"story",characterId:"peach",storyId:"peach_1"},completed:!1},{id:"merge_peach_40",name:"ë¶€ë“œëŸ¬ìš´ í˜",description:"ë³µìˆ­ì•„ë¥¼ 40ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‘",requirement:{type:"merge",fruit:7,count:40},reward:{type:"item",itemType:"upgrade",count:2},completed:!1},{id:"merge_green_45",name:"ê· í˜•ì˜ ë‹¬ì¸",description:"ì²­ì‚¬ê³¼ë¥¼ 45ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ",requirement:{type:"merge",fruit:8,count:45},reward:{type:"story",characterId:"apple",storyId:"apple_1"},completed:!1},{id:"merge_apple_50",name:"ì§€í˜œì˜ ì™„ì„±",description:"ì‚¬ê³¼ë¥¼ 50ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ",requirement:{type:"merge",fruit:9,count:50},reward:{type:"item",itemType:"vibration",count:2},completed:!1},{id:"merge_watermelon_10",name:"í’ìš”ì˜ ì‹œì‘",description:"ìˆ˜ë°•ì„ 10ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‰",requirement:{type:"merge",fruit:10,count:10},reward:{type:"story",characterId:"watermelon",storyId:"watermelon_1"},completed:!1},{id:"merge_watermelon_25",name:"ìˆ˜ë°• ë§ˆìŠ¤í„°",description:"ìˆ˜ë°•ì„ 25ë²ˆ í•©ì¹˜ê¸°",category:"merge",icon:"ğŸ‰",requirement:{type:"merge",fruit:10,count:25},reward:{type:"item",itemType:"remove",count:3},completed:!1},{id:"level_1_clear",name:"ì²« ê±¸ìŒ",description:"ë ˆë²¨ 1 í´ë¦¬ì–´",category:"level",icon:"ğŸ¯",requirement:{type:"level",level:1,count:1},reward:{type:"story",characterId:"cherry",storyId:"cherry_2"},completed:!1},{id:"level_2_clear",name:"ë„ì „ì˜ ì‹œì‘",description:"ë ˆë²¨ 2 í´ë¦¬ì–´",category:"level",icon:"ğŸ¯",requirement:{type:"level",level:2,count:1},reward:{type:"story",characterId:"lemon",storyId:"lemon_1"},completed:!1},{id:"level_3_clear",name:"ì„±ì¥ì˜ ì¦ê±°",description:"ë ˆë²¨ 3 í´ë¦¬ì–´",category:"level",icon:"ğŸ¯",requirement:{type:"level",level:3,count:1},reward:{type:"story",characterId:"peach",storyId:"peach_2"},completed:!1},{id:"level_5_clear",name:"ì™„ì„±ì„ í–¥í•´",description:"ë ˆë²¨ 5 í´ë¦¬ì–´",category:"level",icon:"ğŸ¯",requirement:{type:"level",level:5,count:1},reward:{type:"story",characterId:"apple",storyId:"apple_2"},completed:!1},{id:"level_1_master",name:"ë ˆë²¨ 1 ë§ˆìŠ¤í„°",description:"ë ˆë²¨ 1ì„ 5ë²ˆ í´ë¦¬ì–´",category:"level",icon:"â­",requirement:{type:"level",level:1,count:5},reward:{type:"item",itemType:"remove",count:2},completed:!1},{id:"level_2_master",name:"ë ˆë²¨ 2 ë§ˆìŠ¤í„°",description:"ë ˆë²¨ 2ë¥¼ 3ë²ˆ í´ë¦¬ì–´",category:"level",icon:"â­",requirement:{type:"level",level:2,count:3},reward:{type:"item",itemType:"upgrade",count:2},completed:!1},{id:"total_score_10000",name:"ì ìˆ˜ ìˆ˜ì§‘ê°€",description:"ì´ 10,000ì  íšë“",category:"special",icon:"ğŸ’",requirement:{type:"totalScore",count:1e4},reward:{type:"item",itemType:"vibration",count:1},completed:!1},{id:"total_score_50000",name:"ì ìˆ˜ ë§ˆìŠ¤í„°",description:"ì´ 50,000ì  íšë“",category:"special",icon:"ğŸ’",requirement:{type:"totalScore",count:5e4},reward:{type:"story",characterId:"watermelon",storyId:"watermelon_2"},completed:!1},{id:"play_10_games",name:"ê¾¸ì¤€í•œ í”Œë ˆì´ì–´",description:"10ë²ˆ ê²Œì„ í”Œë ˆì´",category:"special",icon:"ğŸ®",requirement:{type:"gamesPlayed",count:10},reward:{type:"item",itemType:"remove",count:1},completed:!1},{id:"play_50_games",name:"í—Œì‹ ì ì¸ í”Œë ˆì´ì–´",description:"50ë²ˆ ê²Œì„ í”Œë ˆì´",category:"special",icon:"ğŸ®",requirement:{type:"gamesPlayed",count:50},reward:{type:"story",characterId:"watermelon",storyId:"watermelon_3"},completed:!1}];function w(c,e){const t=c.requirement;switch(t.type){case"merge":return(e.merges[t.fruit]||0)>=t.count;case"level":return(e.levelClears[t.level]||0)>=t.count;case"totalScore":return(e.totalScore||0)>=t.count;case"gamesPlayed":return(e.gamesPlayed||0)>=t.count;default:return!1}}function O(c,e){return c.filter(t=>!e.completedAchievements.includes(t.id)&&w(t,e))}class q{constructor(e,t){this.screenManager=e,this.progressManager=t,this.container=null}create(){this.container=document.createElement("div"),this.container.id="achievement-screen",this.container.className="screen",this.container.innerHTML=`
            <div class="achievement-content">
                <div class="achievement-header">
                    <button class="btn-back" id="achievement-back">
                        <span>â†</span>
                    </button>
                    <h2 class="achievement-title">ì—…ì </h2>
                    <div class="header-spacer"></div>
                </div>

                <div class="achievement-list" id="achievement-list">
                    <!-- Achievements will be populated here -->
                </div>

                <nav class="bottom-nav">
                    <button class="nav-btn" data-screen="story">
                        <span class="nav-icon">ğŸ“–</span>
                        <span class="nav-label">ìŠ¤í† ë¦¬</span>
                    </button>
                    <button class="nav-btn" data-screen="lobby">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-label">í™ˆ</span>
                    </button>
                    <button class="nav-btn active" data-screen="achievement">
                        <span class="nav-icon">ğŸ†</span>
                        <span class="nav-label">ì—…ì </span>
                    </button>
                </nav>
            </div>
        `,document.body.appendChild(this.container),this.setupEventListeners()}setupEventListeners(){const e=this.container.querySelector("#achievement-back");e&&e.addEventListener("click",()=>{this.screenManager.showScreen("lobby")}),this.container.querySelectorAll(".nav-btn[data-screen]").forEach(i=>{i.addEventListener("click",()=>{const s=i.getAttribute("data-screen");this.screenManager.showScreen(s)})})}populateAchievements(){const e=this.container.querySelector("#achievement-list");if(!e)return;e.innerHTML="";const t=this.progressManager.getProgress();I.forEach(i=>{const s=this.progressManager.isAchievementClaimed(i.id),n=w(i,t),r=document.createElement("div");let l="";s?l="claimed":n&&(l="unlocked"),r.className=`achievement-item ${l}`;const a=i.icon;let o="";s?o='<div class="achievement-status">âœ…</div>':n?o=`<button class="btn-claim" data-id="${i.id}">ë³´ìƒ ë°›ê¸°</button>`:o='<div class="achievement-status">ğŸ”’</div>',r.innerHTML=`
                <div class="achievement-icon">${a}</div>
                <div class="achievement-info">
                    <div class="achievement-name">${i.name}</div>
                    <div class="achievement-desc">${i.description}</div>
                </div>
                ${o}
            `;const d=r.querySelector(".btn-claim");d&&d.addEventListener("click",m=>{m.stopPropagation(),this.handleClaim(i)}),e.appendChild(r)})}handleClaim(e){this.progressManager.claimAchievement(e.id,e.reward)&&(this.showNotification(e),this.populateAchievements())}showNotification(e){const t=document.createElement("div");t.className="achievement-notification";let i="";e.reward.type==="item"?i=`${{remove:"ì œê±° ì•„ì´í…œ",upgrade:"ì—…ê·¸ë ˆì´ë“œ ì•„ì´í…œ",vibration:"ì§„ë™ ì•„ì´í…œ"}[e.reward.itemType]} x${e.reward.count}`:e.reward.type==="story"&&(i="ìƒˆë¡œìš´ ìŠ¤í† ë¦¬ ì ê¸ˆ í•´ì œ!"),t.innerHTML=`
            <div class="notif-icon">ğŸ‰</div>
            <div class="notif-content">
                <div class="notif-title">ì—…ì  ë‹¬ì„±!</div>
                <div class="notif-desc">${e.name}</div>
                <div class="notif-reward">${i}</div>
            </div>
        `,this.container.appendChild(t),requestAnimationFrame(()=>{t.classList.add("show")}),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.remove()},300)},3e3)}async show(){this.container||this.create(),this.populateAchievements(),this.container.classList.add("active"),this.container.querySelectorAll(".nav-btn").forEach(i=>i.classList.remove("active"));const t=this.container.querySelector('.nav-btn[data-screen="achievement"]');t&&t.classList.add("active")}async hide(){this.container&&this.container.classList.remove("active")}}const g=400,M=600,p=50,D=100,h="https://raw.githubusercontent.com/twitter/twemoji/master/assets/72x72/",u=[{radius:12,score:10,img:h+"1f352.png"},{radius:18,score:20,img:h+"1f353.png"},{radius:24,score:40,img:h+"1f347.png"},{radius:30,score:80,img:h+"1f34a.png"},{radius:38,score:160,img:h+"1f34b.png"},{radius:46,score:320,img:h+"1f348.png"},{radius:54,score:640,img:h+"1f34d.png"},{radius:64,score:1280,img:h+"1f351.png"},{radius:76,score:2560,img:h+"1f34f.png"},{radius:88,score:5120,img:h+"1f34e.png"},{radius:104,score:10240,img:'data:image/svg+xml;charset=utf-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="72px" height="72px" viewBox="0 0 72 72"%3E%3Ccircle cx="36" cy="36" r="34" fill="%234CAF50" stroke="%231B5E20" stroke-width="1"/%3E%3Cpath d="M36 2 C 42 12 44 24 40 36 C 36 48 34 60 36 70 M 18 8 C 24 16 26 28 22 36 C 18 44 16 56 18 64 M 54 8 C 48 16 46 28 50 36 C 54 44 56 56 54 64" stroke="%231B5E20" stroke-width="4" fill="none" stroke-linecap="round"/%3E%3C/svg%3E'}],v={FRICTION:.3,RESTITUTION:.2,DENSITY:.001},f={RESTITUTION_PER_LEVEL:.08,FRICTION_PER_LEVEL:-.03,EXPLOSION_PER_LEVEL:.05},R=.08,x=[0,3e3,8e3,15e3,25e3,4e4,6e4,85e3,115e3,15e4],N=400,P=1e3,y={SLOW_DOWN_DURATION:800,SLOW_MOTION_DURATION:600,SPEED_UP_DURATION:400,MIN_TIME_SCALE:.2},C={DURATION:3e3,RANGE:250,FORCE:.003};class G{constructor(e){this.Engine=Matter.Engine,this.Render=Matter.Render,this.Runner=Matter.Runner,this.Composite=Matter.Composite,this.Bodies=Matter.Bodies,this.Events=Matter.Events,this.engine=this.Engine.create(),this.world=this.engine.world;const t=document.getElementById(e);this.gameWidth=g,this.gameHeight=M,this.render=this.Render.create({canvas:t,engine:this.engine,options:{width:this.gameWidth,height:this.gameHeight,wireframes:!1,background:"#2a2a2a"}}),this.createBoundaries(),this.Render.run(this.render),this.runner=this.Runner.create(),this.Runner.run(this.runner,this.engine)}createBoundaries(){const e=this.Bodies.rectangle(this.gameWidth/2,this.gameHeight+p/2,this.gameWidth,p,{isStatic:!0,render:{visible:!1}}),t=this.Bodies.rectangle(-p/2,this.gameHeight/2,p,this.gameHeight*2,{isStatic:!0,render:{visible:!1}}),i=this.Bodies.rectangle(this.gameWidth+p/2,this.gameHeight/2,p,this.gameHeight*2,{isStatic:!0,render:{visible:!1}});this.Composite.add(this.world,[e,t,i])}addBody(e){this.Composite.add(this.world,e)}removeBody(e){this.Composite.remove(this.world,e)}}class S{static create(e,t,i){const s=u[i],n=s.radius,r=Matter.Bodies.circle(e,t,n,{restitution:v.RESTITUTION,friction:v.FRICTION,density:v.DENSITY,render:{sprite:{texture:s.img,xScale:n*2*1.08/72,yScale:n*2*1.08/72}},label:"circle"});return r.gameData={level:i,hasMerged:!1},r}}class V{constructor(){this.scoreElement=document.getElementById("score"),this.targetScoreElement=document.getElementById("target-score"),this.levelElement=document.getElementById("level"),this.nextCircleElement=document.getElementById("next-circle"),this.scoreIcon=document.getElementById("score-icon"),this.resultScreen=document.getElementById("result-screen"),this.resultTitle=document.getElementById("result-title"),this.resultScore=document.getElementById("result-score"),this.resultButton=document.getElementById("result-button"),this.effectsContainer=document.getElementById("effects-container"),this.btnRemove=document.getElementById("btn-remove"),this.btnUpgrade=document.getElementById("btn-upgrade"),this.btnVibration=document.getElementById("btn-vibration"),this.itemButtons={remove:this.btnRemove,upgrade:this.btnUpgrade,vibration:this.btnVibration},this.currentDisplayedScore=0,this.targetScore=0,this.scoreAnimationId=null}updateScore(e,t){this.targetScore=e,this.scoreAnimationId||this.animateScore();const i=x[t]||"MAX";this.targetScoreElement.textContent=i}animateScore(){if(this.currentDisplayedScore<this.targetScore){const e=this.targetScore-this.currentDisplayedScore,t=Math.ceil(e/10);this.currentDisplayedScore+=t,this.scoreElement.textContent=this.currentDisplayedScore,this.scoreAnimationId=requestAnimationFrame(()=>this.animateScore())}else this.currentDisplayedScore=this.targetScore,this.scoreElement.textContent=this.currentDisplayedScore,this.scoreAnimationId=null}updateLevel(e){this.levelElement.textContent=e}updateNextCircle(e){const t=u[e];this.nextCircleElement.innerHTML="";const i=document.createElement("img");i.src=t.img,i.style.width="100%",i.style.height="100%",i.style.objectFit="contain",this.nextCircleElement.appendChild(i)}showResult(e,t){this.resultScreen.style.display="flex",this.resultTitle.textContent=t?"MISSION COMPLETE!":"GAME OVER",this.resultScore.textContent=`Final Score: ${e}`,this.resultTitle.style.color=t?"#00FF00":"#FF0000",this.resultButton.textContent="Play Again",this.resultButton.onclick=i=>{i.stopPropagation(),location.reload()}}showMissionComplete(e,t,i,s){this.resultScreen.style.display="flex",this.resultTitle.textContent=`LEVEL ${e} CLEARED!`,this.resultTitle.style.color="#00FFFF";const n={remove:"ğŸ—‘ï¸",upgrade:"â¬†ï¸",vibration:"ğŸ“³"},r={remove:"Remove",upgrade:"Upgrade",vibration:"Vibration"};this.resultScore.innerHTML=`Current Score: ${t}<br><br>ğŸ Acquired: ${n[i]} ${r[i]}`,this.resultButton.textContent="Next Level",this.resultButton.onclick=l=>{l.stopPropagation(),this.resultScreen.style.display="none",s()}}toggleItemActive(e,t){Object.values(this.itemButtons).forEach(i=>i.classList.remove("active")),t&&this.itemButtons[e]&&this.itemButtons[e].classList.add("active")}setupItemListeners(e){this.btnRemove.onclick=()=>e("remove"),this.btnUpgrade.onclick=()=>e("upgrade"),this.btnVibration.onclick=()=>e("vibration")}updateItemCount(e,t){const i=this.itemButtons[e];if(!i)return;let s=i.querySelector(".item-count");s||(s=document.createElement("span"),s.className="item-count",i.appendChild(s)),s.textContent=t,t<=0?i.classList.add("disabled"):i.classList.remove("disabled")}updateAllItemCounts(e){this.updateItemCount("remove",e.remove),this.updateItemCount("upgrade",e.upgrade),this.updateItemCount("vibration",e.vibration)}spawnMergeEffect(e,t,i){const s=this.scoreIcon.getBoundingClientRect(),n=document.getElementById("game-container").getBoundingClientRect(),r=s.left-n.left+s.width/2,l=s.top-n.top+s.height/2;for(let a=0;a<3;a++){const o=document.createElement("div");o.className="particle star",o.textContent="â­",o.style.left=e+(Math.random()*40-20)+"px",o.style.top=t+(Math.random()*40-20)+"px";const d=o.animate([{transform:"scale(0.5)",opacity:1,left:o.style.left,top:o.style.top},{transform:"scale(0.2)",opacity:0,left:r+"px",top:l+"px"}],{duration:500,easing:"ease-in",fill:"forwards"});this.effectsContainer.appendChild(o),d.onfinish=()=>{o.remove(),a===0&&this.triggerScoreFlash()}}this.spawnExplosionParticles(e,t)}spawnExplosionParticles(e,t){const i=["ğŸ’¥","âœ¨"];for(let s=0;s<6;s++){const n=document.createElement("div");n.className="particle explosion",n.textContent=i[s%2],n.style.left=e+"px",n.style.top=t+"px";const r=Math.PI*2*s/6,l=50,a=e+Math.cos(r)*l,o=t+Math.sin(r)*l,d=n.animate([{transform:"translate(0, 0) scale(1)",opacity:1},{transform:`translate(${a-e}px, ${o-t}px) scale(0)`,opacity:0}],{duration:350,easing:"ease-out"});this.effectsContainer.appendChild(n),d.onfinish=()=>n.remove()}}spawnBounceEffect(e,t){const i=document.createElement("div");i.className="particle puff",i.textContent="ğŸ’¨",i.style.left=e+"px",i.style.top=t+"px";const s=i.animate([{transform:"scale(0.3)",opacity:.5},{transform:"scale(1)",opacity:0}],{duration:200,easing:"ease-out"});this.effectsContainer.appendChild(i),s.onfinish=()=>i.remove()}spawnItemEffect(e,t,i){const s={remove:"ğŸ—‘ï¸",upgrade:"â¬†ï¸",vibration:"ğŸ“³"};for(let l=0;l<4;l++){const a=document.createElement("div");a.className="particle sparkle",a.textContent="âœ¨",a.style.left=e+(Math.random()*50-25)+"px",a.style.top=t+(Math.random()*50-25)+"px";const o=a.animate([{transform:"scale(0)",opacity:1},{transform:"scale(1)",opacity:0}],{duration:350,easing:"ease-out"});this.effectsContainer.appendChild(a),o.onfinish=()=>a.remove()}const n=document.createElement("div");n.className="particle item-icon",n.textContent=s[i],n.style.left=e+"px",n.style.top=t+"px";const r=n.animate([{transform:"scale(1.5)",opacity:1},{transform:"scale(0)",opacity:0}],{duration:400,easing:"ease-out"});this.effectsContainer.appendChild(n),r.onfinish=()=>n.remove()}spawnLevelCompleteEffect(){const e=["ğŸŠ","ğŸ‰","âœ¨","â­"];for(let t=0;t<12;t++)setTimeout(()=>{const i=document.createElement("div");i.className="particle confetti",i.textContent=e[Math.floor(Math.random()*e.length)],i.style.left=Math.random()*100+"%",i.style.top="-20px";const s=i.animate([{transform:"translateY(0)",opacity:1},{transform:`translateY(${window.innerHeight}px)`,opacity:.5}],{duration:1200,easing:"ease-in"});document.body.appendChild(i),s.onfinish=()=>i.remove()},t*100)}triggerScoreFlash(){this.scoreIcon.classList.remove("flash"),this.scoreIcon.offsetWidth,this.scoreIcon.classList.add("flash")}showAchievementNotification(e){const t=document.createElement("div");t.className="achievement-notification show",t.innerHTML=`
            <div class="notif-icon">${e.icon}</div>
            <div class="notif-content">
                <div class="notif-title">ì—…ì  ë‹¬ì„±!</div>
                <div class="notif-desc">${e.name}</div>
            </div>
        `,t.style.zIndex="2000",document.body.appendChild(t),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.remove()},500)},3e3)}}class F{constructor(){this.audioContext=null,this.masterGain=null,this.bgmGain=null,this.sfxGain=null,this.isMuted=!1,this.volume=.5,this.bgmSource=null,this.isInitialized=!1,this.loadSettings()}async init(){if(!this.isInitialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.sfxGain.connect(this.masterGain),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=this.isMuted?0:this.volume,this.sfxGain.gain.value=.6,this.isInitialized=!0,this.audioContext.state==="suspended"&&await this.audioContext.resume()}catch(e){console.error("Audio initialization failed:",e)}}async play(e){if(this.isInitialized||await this.init(),!this.audioContext)return;if(this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch(i){console.warn("Could not resume audio:",i);return}const t=this.audioContext.currentTime;try{switch(e){case"drop":this.playDrop(t);break;case"merge":this.playMerge(t);break;case"score":this.playScore(t);break;case"itemUse":this.playItemUse(t);break;case"levelComplete":this.playLevelComplete(t);break;case"gameOver":this.playGameOver(t);break}}catch(i){console.warn("Sound play failed:",i)}}playDrop(e){const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.sfxGain),t.type="sine",t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(50,e+.1),i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.start(e),t.stop(e+.1)}playBounce(e){const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.sfxGain),t.type="square",t.frequency.setValueAtTime(300,e),t.frequency.exponentialRampToValueAtTime(150,e+.05),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.01,e+.05),t.start(e),t.stop(e+.05)}playMerge(e){[0,.1,.2].forEach((t,i)=>{const s=this.audioContext.createOscillator(),n=this.audioContext.createGain();s.connect(n),n.connect(this.sfxGain),s.type="sine";const r=[523.25,659.25,783.99][i];s.frequency.setValueAtTime(r,e+t),n.gain.setValueAtTime(.3,e+t),n.gain.exponentialRampToValueAtTime(.01,e+t+.5),s.start(e+t),s.stop(e+t+.5)})}playScore(e){const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.sfxGain),t.type="sine",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1200,e+.1),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.start(e),t.stop(e+.1)}playItemUse(e){const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.sfxGain),t.type="sawtooth",t.frequency.setValueAtTime(100,e),t.frequency.exponentialRampToValueAtTime(500,e+.2),i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.01,e+.2),t.start(e),t.stop(e+.2)}playLevelComplete(e){[523.25,659.25,783.99,1046.5].forEach((i,s)=>{const n=this.audioContext.createOscillator(),r=this.audioContext.createGain();n.connect(r),r.connect(this.sfxGain),n.type="triangle",n.frequency.setValueAtTime(i,e+s*.15),r.gain.setValueAtTime(.3,e+s*.15),r.gain.exponentialRampToValueAtTime(.01,e+s*.15+.3),n.start(e+s*.15),n.stop(e+s*.15+.3)})}playGameOver(e){const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.sfxGain),t.type="sine",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(100,e+.8),i.gain.setValueAtTime(.3,e),i.gain.setValueAtTime(.3,e+.7),i.gain.exponentialRampToValueAtTime(.01,e+.8),t.start(e),t.stop(e+.8)}setVolume(e){this.volume=e,this.masterGain&&!this.isMuted&&(this.masterGain.gain.value=e),this.saveSettings()}toggleMute(){return this.isMuted=!this.isMuted,this.masterGain&&(this.masterGain.gain.value=this.isMuted?0:this.volume),this.saveSettings(),this.isMuted}saveSettings(){localStorage.setItem("gameAudioSettings",JSON.stringify({volume:this.volume,isMuted:this.isMuted}))}loadSettings(){try{const e=JSON.parse(localStorage.getItem("gameAudioSettings"));e&&(this.volume=e.volume??.5,this.isMuted=e.isMuted??!1)}catch{}}}const H=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768;class ${constructor(e){if(this.progressManager=e,this.physics=new G("world"),this.ui=new V,this.audio=new F,this.isMobileDevice=H(),this.isMobileDevice&&console.log("Mobile device detected - enabling optimized effects"),this.score=0,this.level=1,this.nextCircleLevel=0,this.currentCircle=null,this.canDrop=!0,this.isGameOver=!1,this.isMissionComplete=!1,this.activeItem=null,this.activeVibrations=[],this.itemInventory={remove:3,upgrade:3,vibration:3},this.progressManager){const t=this.progressManager.getProgress();this.itemInventory={...t.inventory}}this.setupInput(),this.setupUI(),this.setupCollision(),this.setupGameLoop(),this.spawnNextCircle(),this.ui.updateScore(this.score,this.level),this.ui.updateAllItemCounts(this.itemInventory)}setupUI(){this.ui.setupItemListeners(e=>{this.activeItem===e?(this.activeItem=null,this.ui.toggleItemActive(e,!1)):(this.activeItem&&this.ui.toggleItemActive(this.activeItem,!1),this.activeItem=e,this.ui.toggleItemActive(e,!0))})}setupInput(){const e=document.getElementById("game-container");e.addEventListener("mousemove",t=>{this.currentCircle&&this.canDrop&&!this.isGameOver&&!this.activeItem&&this.updateCurrentCirclePosition(t.clientX)}),e.addEventListener("click",t=>{t.target.closest("#item-bar")||(this.audio.isInitialized||this.audio.init(),!this.isGameOver&&(this.activeItem?this.handleItemClick(t):this.currentCircle&&this.canDrop&&(this.updateCurrentCirclePosition(t.clientX),this.dropCircle())))}),e.addEventListener("touchstart",async()=>{this.audio.isInitialized||await this.audio.init()},{once:!0}),document.addEventListener("visibilitychange",()=>{document.hidden?this.canDrop=!0:setTimeout(()=>{!this.currentCircle&&!this.isGameOver&&!this.isMissionComplete&&(console.log("Recovering from stuck state: Spawning next circle"),this.canDrop=!0,this.spawnNextCircle()),this.audio&&this.audio.context&&this.audio.context.state==="suspended"&&this.audio.context.resume()},100)}),window.addEventListener("mouseup",()=>{})}handleItemClick(e){if(this.itemInventory[this.activeItem]<=0){this.ui.toggleItemActive(this.activeItem,!1),this.activeItem=null;return}const t=document.getElementById("game-container").getBoundingClientRect(),i=g/t.width,s=M/t.height,n=(e.clientX-t.left)*i,r=(e.clientY-t.top)*s,a=Matter.Query.point(Matter.Composite.allBodies(this.physics.world),{x:n,y:r}).find(o=>o.label==="circle"&&!o.isStatic&&!o.isSensor);a&&(this.applyItem(a),this.itemInventory[this.activeItem]--,this.ui.updateItemCount(this.activeItem,this.itemInventory[this.activeItem]),this.ui.toggleItemActive(this.activeItem,!1),this.audio.play("itemUse"),this.activeItem=null)}applyItem(e){switch(this.activeItem){case"remove":this.physics.removeBody(e),this.ui.spawnItemEffect(e.position.x,e.position.y,"remove");break;case"upgrade":if(e.gameData.level<u.length-1){const t=e.gameData.level+1,{x:i,y:s}=e.position;this.physics.removeBody(e);const n=S.create(i,s,t);this.applyLevelPhysics(n),this.physics.addBody(n),this.ui.spawnItemEffect(i,s,"upgrade")}break;case"vibration":this.applyVibration(e),this.ui.spawnItemEffect(e.position.x,e.position.y,"vibration");break}}applyVibration(e){this.activeVibrations.push({body:e,startTime:Date.now(),duration:C.DURATION})}createParticles(e,t,i){this.ui.spawnMergeEffect(e,t,0)}updateCurrentCirclePosition(e){const i=document.getElementById("game-container").getBoundingClientRect(),s=g/i.width;let n=(e-i.left)*s;const r=this.currentCircle.circleRadius;n=Math.max(r,Math.min(n,g-r)),Matter.Body.setPosition(this.currentCircle,{x:n,y:50})}spawnNextCircle(){if(this.isGameOver)return;if(this.currentCircle){console.warn("Attempted to spawn circle while one already exists");return}const e=this.nextCircleLevel;document.getElementById("game-container");const t=g;this.currentCircle=S.create(t/2,50,e),this.currentCircle.isSensor=!0,this.currentCircle.isStatic=!0,this.physics.addBody(this.currentCircle),this.nextCircleLevel=Math.floor(Math.random()*3),this.ui.updateNextCircle(this.nextCircleLevel),this.canDrop=!0}dropCircle(){this.currentCircle&&(this.canDrop=!1,this.currentCircle.isSensor=!1,this.currentCircle.isStatic=!1,this.applyLevelPhysics(this.currentCircle),Matter.Body.setVelocity(this.currentCircle,{x:0,y:5}),this.currentCircle=null,this.audio.play("drop"),setTimeout(()=>{this.isGameOver||this.spawnNextCircle()},N))}applyLevelPhysics(e){const t=this.level-1;e.restitution=Math.min(1.2,v.RESTITUTION+t*f.RESTITUTION_PER_LEVEL),e.friction=Math.max(0,v.FRICTION+t*f.FRICTION_PER_LEVEL)}setupCollision(){Matter.Events.on(this.physics.engine,"collisionStart",e=>{const t=e.pairs;for(let i=0;i<t.length;i++){const s=t[i].bodyA,n=t[i].bodyB;s.gameData&&n.gameData&&this.handleMerge(s,n)}})}handleMerge(e,t){if(e.gameData.level===t.gameData.level&&!e.gameData.hasMerged&&!t.gameData.hasMerged){e.gameData.hasMerged=!0,t.gameData.hasMerged=!0;const i=e.gameData.level+1,s=(e.position.x+t.position.x)/2,n=(e.position.y+t.position.y)/2;if(this.physics.removeBody(e),this.physics.removeBody(t),this.addScore(u[e.gameData.level].score*2),this.ui.spawnMergeEffect(s,n,u[e.gameData.level].score*2),this.audio.play("merge"),this.applyExplosion(s,n,u[e.gameData.level].radius,!1),i<u.length){const r=S.create(s,n,i);this.applyLevelPhysics(r),this.physics.addBody(r)}else this.addScore(u[e.gameData.level].score*4);this.progressManager&&(this.progressManager.recordMerge(e.gameData.level),this.checkAchievements())}}applyExplosion(e,t,i,s=!1){const n=Matter.Composite.allBodies(this.physics.world),r=this.level-1,l=R;let a;s?a=.5:a=(l+r*f.EXPLOSION_PER_LEVEL)*(i/20),n.forEach(o=>{if(o.isStatic)return;const d={x:o.position.x-e,y:o.position.y-t},m=Math.sqrt(d.x*d.x+d.y*d.y);if(m<(s?400:300)&&m>0){const L={x:d.x/m*a*o.mass,y:d.y/m*a*o.mass};Matter.Body.applyForce(o,o.position,L)}})}addScore(e){this.score+=e,this.ui.updateScore(this.score,this.level),this.progressManager&&(this.progressManager.addScore(e),this.checkAchievements()),this.audio.play("score");const t=x[this.level];this.score>=t&&!this.isMissionComplete&&this.missionComplete()}missionComplete(){this.isMissionComplete=!0;const e=this.rewardRandomItem();this.ui.spawnLevelCompleteEffect(),this.audio.play("levelComplete"),this.ui.showMissionComplete(this.level,this.score,e,()=>{this.nextLevel()})}rewardRandomItem(){const e=["remove","upgrade","vibration"],t=e[Math.floor(Math.random()*e.length)];return this.itemInventory[t]++,this.ui.updateItemCount(t,this.itemInventory[t]),t}nextLevel(){this.progressManager&&(this.progressManager.recordLevelClear(this.level),this.checkAchievements()),this.level++,this.ui.updateLevel(this.level),this.ui.updateScore(this.score,this.level),this.isMissionComplete=!1,this.isGameOver=!1,this.currentCircle&&(this.physics.removeBody(this.currentCircle),this.currentCircle=null),this.canDrop=!1,this.spawnNextCircle(),setTimeout(()=>{!this.isGameOver&&!this.isMissionComplete&&(this.canDrop=!0)},P)}setupGameLoop(){Matter.Events.on(this.physics.engine,"afterUpdate",()=>{if(this.isGameOver)return;const e=Matter.Composite.allBodies(this.physics.world),t=Date.now();this.activeVibrations=this.activeVibrations.filter(i=>t-i.startTime>i.duration?(i.body&&i.body.isStatic&&Matter.Body.setStatic(i.body,!1),!1):(i.body&&!i.body.isStatic&&Matter.Body.setStatic(i.body,!0),i.body&&Matter.Body.setAngularVelocity(i.body,.15),e.forEach(s=>{if(s.isStatic||s.isSensor||s===i.body)return;const n=s.position.x-i.body.position.x,r=s.position.y-i.body.position.y;if(Math.sqrt(n*n+r*r)<C.RANGE){const a=C.FORCE*s.mass;Matter.Body.applyForce(s,s.position,{x:(Math.random()-.5)*a,y:(Math.random()-.5)*a})}}),!0));for(const i of e)if(!(i.isStatic||i.isSensor))if(i.bounds.min.y<D){if(!i.gameData.deadlineWarningTime)i.gameData.deadlineWarningTime=Date.now();else if(Date.now()-i.gameData.deadlineWarningTime>500){this.triggerSlowMotionGameOver();break}}else i.gameData.deadlineWarningTime=null})}triggerSlowMotionGameOver(){if(this.isGameOver)return;this.isGameOver=!0;const e=this.physics.engine.timing.timeScale;let t=e;const i=y.SLOW_DOWN_DURATION,s=y.SLOW_MOTION_DURATION,n=y.SPEED_UP_DURATION,r=y.MIN_TIME_SCALE,l=Date.now(),a=()=>{const o=Date.now()-l;if(o<i){const d=o/i;t=e-(e-r)*d,this.physics.engine.timing.timeScale=t,requestAnimationFrame(a)}else if(o<i+s)this.physics.engine.timing.timeScale=r,requestAnimationFrame(a);else if(o<i+s+n){const m=(o-(i+s))/n;t=r+(e-r)*m,this.physics.engine.timing.timeScale=t,requestAnimationFrame(a)}else this.physics.engine.timing.timeScale=e,this.gameOver()};a()}gameOver(){this.isGameOver||(this.isMissionComplete=!1,this.isMobileDevice||this.audio.play("gameOver"),this.progressManager&&(this.progressManager.incrementGamesPlayed(),this.checkAchievements()),this.ui.showResult(this.score,!1))}checkAchievements(){if(!this.progressManager)return;const e=this.progressManager.getProgress();O(I,e).forEach(i=>{this.progressManager.completeAchievement(i.id)&&(this.ui.showAchievementNotification(i),this.isMobileDevice||this.audio.play("levelComplete"))})}}class U{constructor(e,t){this.screenManager=e,this.progressManager=t,this.game=null,this.container=document.getElementById("game-container"),this.uiLayer=document.getElementById("ui-layer"),this.itemBar=document.getElementById("item-bar");const i=document.getElementById("btn-home");i?(console.log("Home button found, attaching listener"),i.addEventListener("click",s=>{console.log("Home button clicked"),s.stopPropagation(),this.showConfirmDialog()})):console.error("Home button not found!")}showConfirmDialog(){const e=document.createElement("div");e.id="home-confirm-dialog",e.innerHTML=`
            <div class="confirm-overlay">
                <div class="confirm-box">
                    <div class="confirm-title">ê²Œì„ ì¢…ë£Œ</div>
                    <div class="confirm-message">ë¡œë¹„ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-yes">í™•ì¸</button>
                        <button class="confirm-btn confirm-no">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(e);const t=e.querySelector(".confirm-yes"),i=e.querySelector(".confirm-no");t.addEventListener("click",()=>{e.remove(),this.hide(),this.screenManager.showScreen("lobby"),this.game=null}),i.addEventListener("click",()=>{e.remove()})}init(){this.game||(this.game=new $(this.progressManager))}async show(){this.game||this.init(),this.container.style.display="block",this.uiLayer.style.display="flex",this.itemBar.style.display="flex",this.game&&this.game.physics&&this.game.physics.engine&&(this.game.physics.engine.enabled=!0)}async hide(){this.container.style.display="none",this.uiLayer.style.display="none",this.itemBar.style.display="none",this.game&&this.game.physics&&this.game.physics.engine&&(this.game.physics.engine.enabled=!1)}}function b(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}window.addEventListener("resize",()=>{b()});window.addEventListener("orientationchange",()=>{b()});b();window.addEventListener("DOMContentLoaded",()=>{const c=new T,e=new _;window.screenManager=c,window.progressManager=e;const t=new k(c,e),i=new B(c,e),s=new q(c,e),n=new U(c,e);c.registerScreen("lobby",t),c.registerScreen("story",i),c.registerScreen("achievement",s),c.registerScreen("game",n),c.showScreen("lobby")});
